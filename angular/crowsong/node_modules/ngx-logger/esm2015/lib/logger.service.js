import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { HttpHeaders, HttpParams } from '@angular/common/http';
import { isPlatformBrowser, DatePipe } from '@angular/common';
import { NGXLoggerHttpService } from './http.service';
import { NgxLoggerLevel } from './types/logger-level.enum';
import { LoggerConfig } from './logger.config';
import { NGXLoggerConfigEngine } from './config.engine';
import { NGXLoggerUtils } from './utils/logger.utils';
import { NGXMapperService } from './mapper.service';
export const Levels = [
    'TRACE',
    'DEBUG',
    'INFO',
    'LOG',
    'WARN',
    'ERROR',
    'FATAL',
    'OFF'
];
export class NGXLogger {
    constructor(mapperService, httpService, loggerConfig, platformId, datePipe) {
        this.mapperService = mapperService;
        this.httpService = httpService;
        this.platformId = platformId;
        this.datePipe = datePipe;
        this._withCredentials = false;
        this._isIE = isPlatformBrowser(platformId) && navigator && navigator.userAgent &&
            !!(navigator.userAgent.indexOf('MSIE') !== -1 || navigator.userAgent.match(/Trident\//) || navigator.userAgent.match(/Edge\//));
        // each instance of the logger should have their own config engine
        this.config = new NGXLoggerConfigEngine(loggerConfig);
        this._logFunc = this._isIE ? this._logIE.bind(this) : this._logModern.bind(this);
    }
    /** Get a readonly access to the level configured for the NGXLogger */
    get level() {
        return this.config.level;
    }
    /** Get a readonly access to the serverLogLevel configured for the NGXLogger */
    get serverLogLevel() {
        return this.config.serverLogLevel;
    }
    trace(message, ...additional) {
        this._log(NgxLoggerLevel.TRACE, message, additional);
    }
    debug(message, ...additional) {
        this._log(NgxLoggerLevel.DEBUG, message, additional);
    }
    info(message, ...additional) {
        this._log(NgxLoggerLevel.INFO, message, additional);
    }
    log(message, ...additional) {
        this._log(NgxLoggerLevel.LOG, message, additional);
    }
    warn(message, ...additional) {
        this._log(NgxLoggerLevel.WARN, message, additional);
    }
    error(message, ...additional) {
        this._log(NgxLoggerLevel.ERROR, message, additional);
    }
    fatal(message, ...additional) {
        this._log(NgxLoggerLevel.FATAL, message, additional);
    }
    setCustomHttpHeaders(headers) {
        this._customHttpHeaders = headers;
    }
    setCustomParams(params) {
        this._customParams = params;
    }
    setWithCredentialsOptionValue(withCredentials) {
        this._withCredentials = withCredentials;
    }
    registerMonitor(monitor) {
        this._loggerMonitor = monitor;
    }
    updateConfig(config) {
        this.config.updateConfig(config);
    }
    getConfigSnapshot() {
        return this.config.getConfig();
    }
    _logIE(level, metaString, message, additional) {
        // Coloring doesn't work in IE
        // make sure additional isn't null or undefined so that ...additional doesn't error
        additional = additional || [];
        switch (level) {
            case NgxLoggerLevel.WARN:
                console.warn(`${metaString} `, message, ...additional);
                break;
            case NgxLoggerLevel.ERROR:
            case NgxLoggerLevel.FATAL:
                console.error(`${metaString} `, message, ...additional);
                break;
            case NgxLoggerLevel.INFO:
                console.info(`${metaString} `, message, ...additional);
                break;
            default:
                console.log(`${metaString} `, message, ...additional);
        }
    }
    _logModern(level, metaString, message, additional) {
        const configuredColors = this.getConfigSnapshot().colorScheme;
        const color = NGXLoggerUtils.getColor(level, configuredColors);
        // make sure additional isn't null or undefined so that ...additional doesn't error
        additional = additional || [];
        switch (level) {
            case NgxLoggerLevel.WARN:
                console.warn(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            case NgxLoggerLevel.ERROR:
            case NgxLoggerLevel.FATAL:
                console.error(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            case NgxLoggerLevel.INFO:
                console.info(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            //  Disabling console.trace since the stack trace is not helpful. it is showing the stack trace of
            // the console.trace statement
            // case NgxLoggerLevel.TRACE:
            //   console.trace(`%c${metaString}`, `color:${color}`, message, ...additional);
            //   break;
            case NgxLoggerLevel.DEBUG:
                console.debug(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            default:
                console.log(`%c${metaString}`, `color:${color}`, message, ...additional);
        }
    }
    _log(level, message, additional = [], logOnServer = true) {
        const config = this.config.getConfig();
        const isLog2Server = logOnServer && config.serverLoggingUrl && level >= config.serverLogLevel;
        const isLogLevelEnabled = level >= config.level;
        if (!(message && (isLog2Server || isLogLevelEnabled))) {
            return;
        }
        const logLevelString = Levels[level];
        message = typeof message === 'function' ? message() : message;
        // only use validated parameters for HTTP requests
        const validatedAdditionalParameters = NGXLoggerUtils.prepareAdditionalParameters(additional);
        const timestamp = config.timestampFormat ?
            this.datePipe.transform(new Date(), config.timestampFormat) :
            new Date().toISOString();
        this.mapperService.getCallerDetails(config.enableSourceMaps, config.proxiedSteps).subscribe((callerDetails) => {
            const logObject = {
                // prepareMessage is needed to match NGXLogInterface
                // Even though I think message should be of type any (same as console.xxx signature)
                // I'm not doing this right now as this would be a breaking change
                message: NGXLoggerUtils.prepareMessage(message),
                additional: validatedAdditionalParameters,
                level: level,
                timestamp: timestamp,
                fileName: callerDetails.fileName,
                lineNumber: callerDetails.lineNumber.toString()
            };
            if (this._loggerMonitor && isLogLevelEnabled) {
                this._loggerMonitor.onLog(logObject);
            }
            if (isLog2Server) {
                // make sure the stack gets sent to the server (without altering the message for console logging)
                logObject.message = message instanceof Error ? message.stack : message;
                logObject.message = NGXLoggerUtils.prepareMessage(logObject.message);
                const headers = this._customHttpHeaders || new HttpHeaders();
                headers.set('Content-Type', 'application/json');
                const options = {
                    headers: headers,
                    params: this._customParams || new HttpParams(),
                    responseType: config.httpResponseType || 'json',
                    withCredentials: this._withCredentials
                };
                // Allow logging on server even if client log level is off
                this.httpService.logOnServer(config.serverLoggingUrl, logObject, options).subscribe((res) => {
                    // I don't think we should do anything on success
                }, (error) => {
                    this._log(NgxLoggerLevel.ERROR, `FAILED TO LOG ON SERVER: ${message}`, [error], false);
                });
            }
            // if no message or the log level is less than the environ
            if (isLogLevelEnabled && !config.disableConsoleLogging) {
                const metaString = NGXLoggerUtils.prepareMetaString(timestamp, logLevelString, config.disableFileDetails ? null : callerDetails.fileName, callerDetails.lineNumber.toString());
                return this._logFunc(level, metaString, message, additional);
            }
        });
    }
}
NGXLogger.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NGXLogger.ctorParameters = () => [
    { type: NGXMapperService },
    { type: NGXLoggerHttpService },
    { type: LoggerConfig },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: DatePipe }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2xvZ2dlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRSxPQUFPLEVBQXFCLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFOUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzNELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHdEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFcEQsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHO0lBQ3BCLE9BQU87SUFDUCxPQUFPO0lBQ1AsTUFBTTtJQUNOLEtBQUs7SUFDTCxNQUFNO0lBQ04sT0FBTztJQUNQLE9BQU87SUFDUCxLQUFLO0NBQ04sQ0FBQztBQUlGLE1BQU0sT0FBTyxTQUFTO0lBVXBCLFlBQTZCLGFBQStCLEVBQW1CLFdBQWlDLEVBQzlHLFlBQTBCLEVBQStCLFVBQVUsRUFDbEQsUUFBa0I7UUFGUixrQkFBYSxHQUFiLGFBQWEsQ0FBa0I7UUFBbUIsZ0JBQVcsR0FBWCxXQUFXLENBQXNCO1FBQ3JELGVBQVUsR0FBVixVQUFVLENBQUE7UUFDbEQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQU43QixxQkFBZ0IsR0FBWSxLQUFL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QUU7b0JBQzNCLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSw0QkFBNEIsT0FBTyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDekYsQ0FBQyxDQUNGLENBQUM7YUFDSDtZQUdELDBEQUEwRDtZQUMxRCxJQUFJLGlCQUFpQixJQUFJLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFO2dCQUN0RCxNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsaUJBQWlCLENBQ2pELFNBQVMsRUFDVCxjQUFjLEVBQ2QsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQ3pELGFBQWEsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQ3BDLENBQUM7Z0JBRUYsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQzlEO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7WUF0TkYsVUFBVTs7OztZQWRGLGdCQUFnQjtZQVJoQixvQkFBb0I7WUFHcEIsWUFBWTs0Q0ErQlksTUFBTSxTQUFDLFdBQVc7WUFwQ3ZCLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwSGVhZGVycywgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIsIERhdGVQaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuXHJcbmltcG9ydCB7IE5HWExvZ2dlckh0dHBTZXJ2aWNlIH0gZnJvbSAnLi9odHRwLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMb2dQb3NpdGlvbiB9IGZyb20gJy4vdHlwZXMvbG9nLXBvc2l0aW9uJztcclxuaW1wb3J0IHsgTmd4TG9nZ2VyTGV2ZWwgfSBmcm9tICcuL3R5cGVzL2xvZ2dlci1sZXZlbC5lbnVtJztcclxuaW1wb3J0IHsgTG9nZ2VyQ29uZmlnIH0gZnJvbSAnLi9sb2dnZXIuY29uZmlnJztcclxuaW1wb3J0IHsgTkdYTG9nZ2VyQ29uZmlnRW5naW5lIH0gZnJvbSAnLi9jb25maWcuZW5naW5lJztcclxuaW1wb3J0IHsgTkdYTG9nZ2VyVXRpbHMgfSBmcm9tICcuL3V0aWxzL2xvZ2dlci51dGlscyc7XHJcbmltcG9ydCB7IE5HWExvZ2dlck1vbml0b3IgfSBmcm9tICcuL2xvZ2dlci1tb25pdG9yJztcclxuaW1wb3J0IHsgTkdYTG9nSW50ZXJmYWNlIH0gZnJvbSAnLi90eXBlcy9uZ3gtbG9nLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IE5HWE1hcHBlclNlcnZpY2UgfSBmcm9tICcuL21hcHBlci5zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBjb25zdCBMZXZlbHMgPSBbXHJcbiAgJ1RSQUNFJyxcclxuICAnREVCVUcnLFxyXG4gICdJTkZPJyxcclxuICAnTE9HJyxcclxuICAnV0FSTicsXHJcbiAgJ0VSUk9SJyxcclxuICAnRkFUQUwnLFxyXG4gICdPRkYnXHJcbl07XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTkdYTG9nZ2VyIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IF9pc0lFOiBib29sZWFuO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2xvZ0Z1bmM6IEZ1bmN0aW9uO1xyXG4gIHByaXZhdGUgY29uZmlnOiBOR1hMb2dnZXJDb25maWdFbmdpbmU7XHJcbiAgcHJpdmF0ZSBfY3VzdG9tSHR0cEhlYWRlcnM6IEh0dHBIZWFkZXJzO1xyXG4gIHByaXZhdGUgX2N1c3RvbVBhcmFtczogSHR0cFBhcmFtcztcclxuICBwcml2YXRlIF93aXRoQ3JlZGVudGlhbHM6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgcHJpdmF0ZSBfbG9nZ2VyTW9uaXRvcjogTkdYTG9nZ2VyTW9uaXRvcjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBtYXBwZXJTZXJ2aWNlOiBOR1hNYXBwZXJTZXJ2aWNlLCBwcml2YXRlIHJlYWRvbmx5IGh0dHBTZXJ2aWNlOiBOR1hMb2dnZXJIdHRwU2VydmljZSxcclxuICAgIGxvZ2dlckNvbmZpZzogTG9nZ2VyQ29uZmlnLCBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGVQaXBlOiBEYXRlUGlwZSkge1xyXG4gICAgdGhpcy5faXNJRSA9IGlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpICYmIG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IudXNlckFnZW50ICYmXHJcbiAgICAgICEhKG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignTVNJRScpICE9PSAtMSB8fCBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9UcmlkZW50XFwvLykgfHwgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvRWRnZVxcLy8pKTtcclxuXHJcbiAgICAvLyBlYWNoIGluc3RhbmNlIG9mIHRoZSBsb2dnZXIgc2hvdWxkIGhhdmUgdGhlaXIgb3duIGNvbmZpZyBlbmdpbmVcclxuICAgIHRoaXMuY29uZmlnID0gbmV3IE5HWExvZ2dlckNvbmZpZ0VuZ2luZShsb2dnZXJDb25maWcpO1xyXG5cclxuICAgIHRoaXMuX2xvZ0Z1bmMgPSB0aGlzLl9pc0lFID8gdGhpcy5fbG9nSUUuYmluZCh0aGlzKSA6IHRoaXMuX2xvZ01vZGVybi5iaW5kKHRoaXMpO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKiBHZXQgYSByZWFkb25seSBhY2Nlc3MgdG8gdGhlIGxldmVsIGNvbmZpZ3VyZWQgZm9yIHRoZSBOR1hMb2dnZXIgKi9cclxuICBnZXQgbGV2ZWwoKTogTmd4TG9nZ2VyTGV2ZWwge1xyXG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLmxldmVsO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldCBhIHJlYWRvbmx5IGFjY2VzcyB0byB0aGUgc2VydmVyTG9nTGV2ZWwgY29uZmlndXJlZCBmb3IgdGhlIE5HWExvZ2dlciAqL1xyXG4gIGdldCBzZXJ2ZXJMb2dMZXZlbCgpOiBOZ3hMb2dnZXJMZXZlbCB7XHJcbiAgICByZXR1cm4gdGhpcy5jb25maWcuc2VydmVyTG9nTGV2ZWw7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgdHJhY2UobWVzc2FnZSwgLi4uYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcclxuICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5UUkFDRSwgbWVzc2FnZSwgYWRkaXRpb25hbCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGVidWcobWVzc2FnZSwgLi4uYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcclxuICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5ERUJVRywgbWVzc2FnZSwgYWRkaXRpb25hbCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaW5mbyhtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xyXG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLklORk8sIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGxvZyhtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xyXG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLkxPRywgbWVzc2FnZSwgYWRkaXRpb25hbCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgd2FybihtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xyXG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLldBUk4sIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGVycm9yKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XHJcbiAgICB0aGlzLl9sb2coTmd4TG9nZ2VyTGV2ZWwuRVJST1IsIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGZhdGFsKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XHJcbiAgICB0aGlzLl9sb2coTmd4TG9nZ2VyTGV2ZWwuRkFUQUwsIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldEN1c3RvbUh0dHBIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKSB7XHJcbiAgICB0aGlzLl9jdXN0b21IdHRwSGVhZGVycyA9IGhlYWRlcnM7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0Q3VzdG9tUGFyYW1zKHBhcmFtczogSHR0cFBhcmFtcykge1xyXG4gICAgdGhpcy5fY3VzdG9tUGFyYW1zID0gcGFyYW1zO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldFdpdGhDcmVkZW50aWFsc09wdGlvblZhbHVlKHdpdGhDcmVkZW50aWFsczogYm9vbGVhbikge1xyXG4gICAgdGhpcy5fd2l0aENyZWRlbnRpYWxzID0gd2l0aENyZWRlbnRpYWxzO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlZ2lzdGVyTW9uaXRvcihtb25pdG9yOiBOR1hMb2dnZXJNb25pdG9yKSB7XHJcbiAgICB0aGlzLl9sb2dnZXJNb25pdG9yID0gbW9uaXRvcjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyB1cGRhdGVDb25maWcoY29uZmlnOiBMb2dnZXJDb25maWcpIHtcclxuICAgIHRoaXMuY29uZmlnLnVwZGF0ZUNvbmZpZyhjb25maWcpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldENvbmZpZ1NuYXBzaG90KCk6IExvZ2dlckNvbmZpZyB7XHJcbiAgICByZXR1cm4gdGhpcy5jb25maWcuZ2V0Q29uZmlnKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9sb2dJRShsZXZlbDogTmd4TG9nZ2VyTGV2ZWwsIG1ldGFTdHJpbmc6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCBhZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xyXG5cclxuICAgIC8vIENvbG9yaW5nIGRvZXNuJ3Qgd29yayBpbiBJRVxyXG4gICAgLy8gbWFrZSBzdXJlIGFkZGl0aW9uYWwgaXNuJ3QgbnVsbCBvciB1bmRlZmluZWQgc28gdGhhdCAuLi5hZGRpdGlvbmFsIGRvZXNuJ3QgZXJyb3JcclxuICAgIGFkZGl0aW9uYWwgPSBhZGRpdGlvbmFsIHx8IFtdO1xyXG5cclxuICAgIHN3aXRjaCAobGV2ZWwpIHtcclxuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5XQVJOOlxyXG4gICAgICAgIGNvbnNvbGUud2FybihgJHttZXRhU3RyaW5nfSBgLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5FUlJPUjpcclxuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5GQVRBTDpcclxuICAgICAgICBjb25zb2xlLmVycm9yKGAke21ldGFTdHJpbmd9IGAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlIE5neExvZ2dlckxldmVsLklORk86XHJcbiAgICAgICAgY29uc29sZS5pbmZvKGAke21ldGFTdHJpbmd9IGAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIGNvbnNvbGUubG9nKGAke21ldGFTdHJpbmd9IGAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfbG9nTW9kZXJuKGxldmVsOiBOZ3hMb2dnZXJMZXZlbCwgbWV0YVN0cmluZzogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIGFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb25maWd1cmVkQ29sb3JzID0gdGhpcy5nZXRDb25maWdTbmFwc2hvdCgpLmNvbG9yU2NoZW1lO1xyXG4gICAgY29uc3QgY29sb3IgPSBOR1hMb2dnZXJVdGlscy5nZXRDb2xvcihsZXZlbCwgY29uZmlndXJlZENvbG9ycyk7XHJcblxyXG4gICAgLy8gbWFrZSBzdXJlIGFkZGl0aW9uYWwgaXNuJ3QgbnVsbCBvciB1bmRlZmluZWQgc28gdGhhdCAuLi5hZGRpdGlvbmFsIGRvZXNuJ3QgZXJyb3JcclxuICAgIGFkZGl0aW9uYWwgPSBhZGRpdGlvbmFsIHx8IFtdO1xyXG5cclxuICAgIHN3aXRjaCAobGV2ZWwpIHtcclxuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5XQVJOOlxyXG4gICAgICAgIGNvbnNvbGUud2FybihgJWMke21ldGFTdHJpbmd9YCwgYGNvbG9yOiR7Y29sb3J9YCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuRVJST1I6XHJcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuRkFUQUw6XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihgJWMke21ldGFTdHJpbmd9YCwgYGNvbG9yOiR7Y29sb3J9YCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuSU5GTzpcclxuICAgICAgICBjb25zb2xlLmluZm8oYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICAvLyAgRGlzYWJsaW5nIGNvbnNvbGUudHJhY2Ugc2luY2UgdGhlIHN0YWNrIHRyYWNlIGlzIG5vdCBoZWxwZnVsLiBpdCBpcyBzaG93aW5nIHRoZSBzdGFjayB0cmFjZSBvZlxyXG4gICAgICAvLyB0aGUgY29uc29sZS50cmFjZSBzdGF0ZW1lbnRcclxuICAgICAgLy8gY2FzZSBOZ3hMb2dnZXJMZXZlbC5UUkFDRTpcclxuICAgICAgLy8gICBjb25zb2xlLnRyYWNlKGAlYyR7bWV0YVN0cmluZ31gLCBgY29sb3I6JHtjb2xvcn1gLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcclxuICAgICAgLy8gICBicmVhaztcclxuXHJcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuREVCVUc6XHJcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgJWMke21ldGFTdHJpbmd9YCwgYGNvbG9yOiR7Y29sb3J9YCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgY29uc29sZS5sb2coYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfbG9nKGxldmVsOiBOZ3hMb2dnZXJMZXZlbCwgbWVzc2FnZSwgYWRkaXRpb25hbDogYW55W10gPSBbXSwgbG9nT25TZXJ2ZXI6IGJvb2xlYW4gPSB0cnVlKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb25maWcgPSB0aGlzLmNvbmZpZy5nZXRDb25maWcoKTtcclxuICAgIGNvbnN0IGlzTG9nMlNlcnZlciA9IGxvZ09uU2VydmVyICYmIGNvbmZpZy5zZXJ2ZXJMb2dnaW5nVXJsICYmIGxldmVsID49IGNvbmZpZy5zZXJ2ZXJMb2dMZXZlbDtcclxuICAgIGNvbnN0IGlzTG9nTGV2ZWxFbmFibGVkID0gbGV2ZWwgPj0gY29uZmlnLmxldmVsO1xyXG5cclxuICAgIGlmICghKG1lc3NhZ2UgJiYgKGlzTG9nMlNlcnZlciB8fCBpc0xvZ0xldmVsRW5hYmxlZCkpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBsb2dMZXZlbFN0cmluZyA9IExldmVsc1tsZXZlbF07XHJcblxyXG4gICAgbWVzc2FnZSA9IHR5cGVvZiBtZXNzYWdlID09PSAnZnVuY3Rpb24nID8gbWVzc2FnZSgpIDogbWVzc2FnZTtcclxuXHJcbiAgICAvLyBvbmx5IHVzZSB2YWxpZGF0ZWQgcGFyYW1ldGVycyBmb3IgSFRUUCByZXF1ZXN0c1xyXG4gICAgY29uc3QgdmFsaWRhdGVkQWRkaXRpb25hbFBhcmFtZXRlcnMgPSBOR1hMb2dnZXJVdGlscy5wcmVwYXJlQWRkaXRpb25hbFBhcmFtZXRlcnMoYWRkaXRpb25hbCk7XHJcblxyXG4gICAgY29uc3QgdGltZXN0YW1wID0gY29uZmlnLnRpbWVzdGFtcEZvcm1hdCA/XHJcbiAgICAgIHRoaXMuZGF0ZVBpcGUudHJhbnNmb3JtKG5ldyBEYXRlKCksIGNvbmZpZy50aW1lc3RhbXBGb3JtYXQpIDpcclxuICAgICAgbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xyXG5cclxuICAgIHRoaXMubWFwcGVyU2VydmljZS5nZXRDYWxsZXJEZXRhaWxzKGNvbmZpZy5lbmFibGVTb3VyY2VNYXBzLCBjb25maWcucHJveGllZFN0ZXBzKS5zdWJzY3JpYmUoKGNhbGxlckRldGFpbHM6IExvZ1Bvc2l0aW9uKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxvZ09iamVjdDogTkdYTG9nSW50ZXJmYWNlID0ge1xyXG4gICAgICAgIC8vIHByZXBhcmVNZXNzYWdlIGlzIG5lZWRlZCB0byBtYXRjaCBOR1hMb2dJbnRlcmZhY2VcclxuICAgICAgICAvLyBFdmVuIHRob3VnaCBJIHRoaW5rIG1lc3NhZ2Ugc2hvdWxkIGJlIG9mIHR5cGUgYW55IChzYW1lIGFzIGNvbnNvbGUueHh4IHNpZ25hdHVyZSlcclxuICAgICAgICAvLyBJJ20gbm90IGRvaW5nIHRoaXMgcmlnaHQgbm93IGFzIHRoaXMgd291bGQgYmUgYSBicmVha2luZyBjaGFuZ2VcclxuICAgICAgICBtZXNzYWdlOiBOR1hMb2dnZXJVdGlscy5wcmVwYXJlTWVzc2FnZShtZXNzYWdlKSxcclxuICAgICAgICBhZGRpdGlvbmFsOiB2YWxpZGF0ZWRBZGRpdGlvbmFsUGFyYW1ldGVycyxcclxuICAgICAgICBsZXZlbDogbGV2ZWwsXHJcbiAgICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAsXHJcbiAgICAgICAgZmlsZU5hbWU6IGNhbGxlckRldGFpbHMuZmlsZU5hbWUsXHJcbiAgICAgICAgbGluZU51bWJlcjogY2FsbGVyRGV0YWlscy5saW5lTnVtYmVyLnRvU3RyaW5nKClcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGlmICh0aGlzLl9sb2dnZXJNb25pdG9yICYmIGlzTG9nTGV2ZWxFbmFibGVkKSB7XHJcbiAgICAgICAgdGhpcy5fbG9nZ2VyTW9uaXRvci5vbkxvZyhsb2dPYmplY3QpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoaXNMb2cyU2VydmVyKSB7XHJcbiAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSBzdGFjayBnZXRzIHNlbnQgdG8gdGhlIHNlcnZlciAod2l0aG91dCBhbHRlcmluZyB0aGUgbWVzc2FnZSBmb3IgY29uc29sZSBsb2dnaW5nKVxyXG4gICAgICAgIGxvZ09iamVjdC5tZXNzYWdlID0gbWVzc2FnZSBpbnN0YW5jZW9mIEVycm9yID8gbWVzc2FnZS5zdGFjayA6IG1lc3NhZ2U7XHJcbiAgICAgICAgbG9nT2JqZWN0Lm1lc3NhZ2UgPSBOR1hMb2dnZXJVdGlscy5wcmVwYXJlTWVzc2FnZShsb2dPYmplY3QubWVzc2FnZSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSB0aGlzLl9jdXN0b21IdHRwSGVhZGVycyB8fCBuZXcgSHR0cEhlYWRlcnMoKTtcclxuICAgICAgICBoZWFkZXJzLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcclxuXHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnMsXHJcbiAgICAgICAgICBwYXJhbXM6IHRoaXMuX2N1c3RvbVBhcmFtcyB8fCBuZXcgSHR0cFBhcmFtcygpLFxyXG4gICAgICAgICAgcmVzcG9uc2VUeXBlOiBjb25maWcuaHR0cFJlc3BvbnNlVHlwZSB8fCAnanNvbicsXHJcbiAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRoaXMuX3dpdGhDcmVkZW50aWFsc1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8gQWxsb3cgbG9nZ2luZyBvbiBzZXJ2ZXIgZXZlbiBpZiBjbGllbnQgbG9nIGxldmVsIGlzIG9mZlxyXG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2UubG9nT25TZXJ2ZXIoY29uZmlnLnNlcnZlckxvZ2dpbmdVcmwsIGxvZ09iamVjdCwgb3B0aW9ucykuc3Vic2NyaWJlKChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgLy8gSSBkb24ndCB0aGluayB3ZSBzaG91bGQgZG8gYW55dGhpbmcgb24gc3VjY2Vzc1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgICAoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5FUlJPUiwgYEZBSUxFRCBUTyBMT0cgT04gU0VSVkVSOiAke21lc3NhZ2V9YCwgW2Vycm9yXSwgZmFsc2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuXHJcblxyXG4gICAgICAvLyBpZiBubyBtZXNzYWdlIG9yIHRoZSBsb2cgbGV2ZWwgaXMgbGVzcyB0aGFuIHRoZSBlbnZpcm9uXHJcbiAgICAgIGlmIChpc0xvZ0xldmVsRW5hYmxlZCAmJiAhY29uZmlnLmRpc2FibGVDb25zb2xlTG9nZ2luZykge1xyXG4gICAgICAgIGNvbnN0IG1ldGFTdHJpbmcgPSBOR1hMb2dnZXJVdGlscy5wcmVwYXJlTWV0YVN0cmluZyhcclxuICAgICAgICAgIHRpbWVzdGFtcCxcclxuICAgICAgICAgIGxvZ0xldmVsU3RyaW5nLFxyXG4gICAgICAgICAgY29uZmlnLmRpc2FibGVGaWxlRGV0YWlscyA/IG51bGwgOiBjYWxsZXJEZXRhaWxzLmZpbGVOYW1lLFxyXG4gICAgICAgICAgY2FsbGVyRGV0YWlscy5saW5lTnVtYmVyLnRvU3RyaW5nKClcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5fbG9nRnVuYyhsZXZlbCwgbWV0YVN0cmluZywgbWVzc2FnZSwgYWRkaXRpb25hbCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=